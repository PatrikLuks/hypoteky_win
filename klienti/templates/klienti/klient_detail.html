{% extends 'base.html' %}
{% load l10n %}
{% load klient_filters %}
{% block content %}
<div class="container-fluid" role="main" aria-label="Hlavní obsah">
<h1 class="mb-4"><i class="fa fa-user text-primary"></i> Detail klienta</h1>
<table class="table table-bordered mb-4 table-striped">
  <tr><th>Jméno klienta</th><td>{{ klient.jmeno }}</td></tr>
  <tr><th>Datum založení</th><td>{{ klient.datum|date:"d.m.Y" }}</td></tr>
  <tr><th>Co financuje</th><td>{{ klient.co_financuje }}</td></tr>
  <tr><th>Cena</th><td>{{ klient.cena|floatformat:0 }} Kč</td></tr>
  <tr><th>Návrh financování</th><td>{{ klient.navrh_financovani }}</td></tr>
  <tr><th>Návrh financování (částka)</th><td>{% if klient.navrh_financovani_castka %}{{ klient.navrh_financovani_castka|floatformat:0 }} Kč{% else %}-{% endif %}</td></tr>
  <tr><th>Návrh financování (%)</th><td>{% if klient.navrh_financovani_procento %}{{ klient.navrh_financovani_procento|floatformat:2 }} %{% else %}-{% endif %}</td></tr>
  <tr><th>Výběr banky</th><td>{{ klient.vyber_banky }}</td></tr>
  <tr><th>Příprava žádosti</th><td>{{ klient.priprava_zadosti }}</td></tr>
  <tr><th>Kompletace podkladů</th><td>{{ klient.kompletace_podkladu }}</td></tr>
  <tr><th>Podání žádosti</th><td>{{ klient.podani_zadosti }}</td></tr>
  <tr><th>Odhad</th><td>{{ klient.odhad }}</td></tr>
  <tr><th>Schvalování</th><td>{{ klient.schvalovani }}</td></tr>
  <tr><th>Příprava úvěrové dokumentace</th><td>{{ klient.priprava_uverove_dokumentace }}</td></tr>
  <tr><th>Podpis úvěrové dokumentace</th><td>{{ klient.podpis_uverove_dokumentace }}</td></tr>
  <tr><th>Příprava čerpání</th><td>{{ klient.priprava_cerpani }}</td></tr>
  <tr><th>Čerpání</th><td>{{ klient.cerpani }}</td></tr>
  <tr><th>Zahájení splácení</th><td>{{ klient.zahajeni_splaceni }}</td></tr>
  <tr><th>Podmínky pro splacení</th><td>{{ klient.podminky_pro_splaceni }}</td></tr>
</table>
<h4 class="mb-3"><i class="fa fa-calendar-alt text-secondary"></i> Deadliny a data splnění jednotlivých kroků</h4>
<table class="table table-sm table-striped">
  <thead class="table-light">
    <tr>
      <th>Krok</th>
      <th>Deadline</th>
      <th>Datum splnění</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>Co chce klient financovat</td><td>{{ klient.deadline_co_financuje|date:"d.m.Y" }}</td><td>{{ klient.splneno_co_financuje|date:"d.m.Y" }}</td></tr>
    <tr><td>Návrh financování</td><td>{{ klient.deadline_navrh_financovani|date:"d.m.Y" }}</td><td>{{ klient.splneno_navrh_financovani|date:"d.m.Y" }}</td></tr>
    <tr><td>Výběr banky</td><td>{{ klient.deadline_vyber_banky|date:"d.m.Y" }}</td><td>{{ klient.splneno_vyber_banky|date:"d.m.Y" }}</td></tr>
    <tr><td>Příprava žádosti</td><td>{{ klient.deadline_priprava_zadosti|date:"d.m.Y" }}</td><td>{{ klient.splneno_priprava_zadosti|date:"d.m.Y" }}</td></tr>
    <tr><td>Kompletace podkladů</td><td>{{ klient.deadline_kompletace_podkladu|date:"d.m.Y" }}</td><td>{{ klient.splneno_kompletace_podkladu|date:"d.m.Y" }}</td></tr>
    <tr><td>Podání žádosti</td><td>{{ klient.deadline_podani_zadosti|date:"d.m.Y" }}</td><td>{{ klient.splneno_podani_zadosti|date:"d.m.Y" }}</td></tr>
    <tr><td>Odhad</td><td>{{ klient.deadline_odhad|date:"d.m.Y" }}</td><td>{{ klient.splneno_odhad|date:"d.m.Y" }}</td></tr>
    <tr><td>Schvalování</td><td>{{ klient.deadline_schvalovani|date:"d.m.Y" }}</td><td>{{ klient.splneno_schvalovani|date:"d.m.Y" }}</td></tr>
    <tr><td>Příprava úvěrové dokumentace</td><td>{{ klient.deadline_priprava_uverove_dokumentace|date:"d.m.Y" }}</td><td>{{ klient.splneno_priprava_uverove_dokumentace|date:"d.m.Y" }}</td></tr>
    <tr><td>Podpis úvěrové dokumentace</td><td>{{ klient.deadline_podpis_uverove_dokumentace|date:"d.m.Y" }}</td><td>{{ klient.splneno_podpis_uverove_dokumentace|date:"d.m.Y" }}</td></tr>
    <tr><td>Příprava čerpání</td><td>{{ klient.deadline_priprava_cerpani|date:"d.m.Y" }}</td><td>{{ klient.splneno_priprava_cerpani|date:"d.m.Y" }}</td></tr>
    <tr><td>Čerpání</td><td>{{ klient.deadline_cerpani|date:"d.m.Y" }}</td><td>{{ klient.splneno_cerpani|date:"d.m.Y" }}</td></tr>
    <tr><td>Zahájení splácení</td><td>{{ klient.deadline_zahajeni_splaceni|date:"d.m.Y" }}</td><td>{{ klient.splneno_zahajeni_splaceni|date:"d.m.Y" }}</td></tr>
    <tr><td>Podmínky pro splacení</td><td>{{ klient.deadline_podminky_pro_splaceni|date:"d.m.Y" }}</td><td>{{ klient.splneno_podminky_pro_splaceni|date:"d.m.Y" }}</td></tr>
  </tbody>
</table>
<h4 class="mt-4"><i class="fa fa-sticky-note text-secondary"></i> Poznámky ke klientovi</h4>
<div class="mb-3">
  <form method="post" class="mb-2">
    {% csrf_token %}
    <div class="input-group">
      <textarea name="text" class="form-control" rows="2" placeholder="Přidat poznámku..." required></textarea>
      <button type="submit" name="nova_poznamka" class="btn btn-primary"><i class="fa fa-plus"></i> Přidat</button>
    </div>
  </form>
  {% if poznamky %}
    <ul class="list-group">
      {% for p in poznamky %}
        <li class="list-group-item small d-flex justify-content-between align-items-start">
          <div>
            <span class="fw-bold">{{ p.author|default:'Uživatel' }}</span> <span class="text-muted">{{ p.created|date:"d.m.Y H:i" }}</span><br>
            {{ p.text|linebreaksbr }}
          </div>
          <form method="post" action="{% url 'smazat_poznamku' klient.pk p.pk %}" style="margin-left: 10px;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Smazat poznámku"><i class="fa fa-trash"></i></button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="text-muted">Žádné poznámky.</div>
  {% endif %}
</div>
<h4 class="mt-4"><i class="fa fa-history text-secondary"></i> Historie změn (auditní log)</h4>
<table class="table table-sm table-striped">
  <thead class="table-light">
    <tr>
      <th>Datum</th>
      <th>Autor</th>
      <th>Popis změny</th>
    </tr>
  </thead>
  <tbody>
    {% for z in zmeny %}
      <tr>
        <td>{{ z.created|date:"d.m.Y H:i" }}</td>
        <td>{{ z.author|default:'-' }}</td>
        <td style="white-space: pre-line;">{{ z.popis }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="3" class="text-muted">Žádné změny nejsou evidovány.</td></tr>
    {% endfor %}
  </tbody>
</table>
<h4 class="mt-4"><i class="fa fa-route text-secondary"></i> Průběh workflow</h4>
<div class="mb-4">
  <div class="d-flex flex-row flex-nowrap overflow-auto" style="gap: 1.5rem;">
    {% comment %} Timeline workflow bez bloku with, pouze for cyklus {% endcomment %}
    {% for step in workflow_steps %}
      <div class="text-center {% if forloop.counter0 == aktivni_krok %}border border-3 border-primary shadow bg-white{% endif %}"
           style="min-width: 120px; border-radius: 12px; padding: 4px 0 8px 0; position: relative;">
        {% if klient|attr:step.pole %}
          <div class="rounded-circle bg-success text-white mx-auto mb-1"
               style="width: 36px; height: 36px; line-height: 36px; font-size: 1.2em;"
               data-bs-toggle="tooltip" data-bs-placement="top"
               title="Krok splněn\n{{ step.popis }}\n{% if step.deadline %}Deadline: {{ step.deadline|date:'d.m.Y' }}{% endif %}{% if step.poznamky %}\nPoznámky: {{ step.poznamky|length }}{% endif %}">
            <i class="fa fa-check"></i>
          </div>
        {% else %}
          <div class="rounded-circle mx-auto mb-1
            {% if step.stav_deadlinu == 'po_termínu' %} bg-danger text-white border-danger
            {% elif step.stav_deadlinu == 'blizi_se' %} bg-warning text-dark border-warning
            {% else %} bg-light border text-secondary{% endif %}"
            style="width: 36px; height: 36px; line-height: 36px; font-size: 1.2em; position: relative;"
            data-bs-toggle="tooltip" data-bs-placement="top"
            title="{{ step.popis }}\n{% if step.deadline %}Deadline: {{ step.deadline|date:'d.m.Y' }}{% endif %}{% if step.poznamky %}\nPoznámky: {{ step.poznamky|length }}{% endif %}">
            <i class="fa fa-circle"></i>
            {% if step.stav_deadlinu == 'po_termínu' %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size:0.8em;">
                <i class="fa fa-exclamation-triangle"></i>
              </span>
            {% elif step.stav_deadlinu == 'blizi_se' %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="font-size:0.8em;">
                <i class="fa fa-clock"></i>
              </span>
            {% endif %}
          </div>
        {% endif %}
        <div style="font-size: 0.95em;">
          {{ step.popis }}
        </div>
        <div class="small text-muted">
          {% if step.deadline %}
            <span {% if step.stav_deadlinu == 'po_termínu' %}class="text-danger fw-bold"{% elif step.stav_deadlinu == 'blizi_se' %}class="text-warning fw-bold"{% endif %}>
              Deadline: {{ step.deadline|date:"d.m.Y" }}
            </span>
          {% endif %}
        </div>
        <div class="mt-1 d-flex justify-content-center gap-1">
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#addNoteModal{{ forloop.counter }}" title="Přidat poznámku ke kroku">
            <i class="fa fa-sticky-note"></i>
          </button>
          {% if step.poznamky and step.poznamky|length > 0 %}
            <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#notesCollapse{{ forloop.counter }}" aria-expanded="false" aria-controls="notesCollapse{{ forloop.counter }}">
              <i class="fa fa-comment-dots"></i> Zobrazit poznámky ({{ step.poznamky|length }})
            </button>
          {% endif %}
        </div>
        {% if step.poznamky and step.poznamky|length > 0 %}
        <div class="collapse mt-2" id="notesCollapse{{ forloop.counter }}">
          <div class="card card-body p-2 small text-start" style="max-width: 260px; margin: 0 auto;">
            <ul class="list-group list-group-flush">
              {% for p in step.poznamky %}
                <li class="list-group-item py-1 px-2">
                  <span class="fw-bold">{{ p.author|default:'Uživatel' }}</span> <span class="text-muted">{{ p.created|date:"d.m.Y H:i" }}</span><br>
                  {{ p.text|linebreaksbr }}
                </li>
              {% endfor %}
            </ul>
          </div>
        </div>
        {% endif %}
        <!-- Modal pro přidání poznámky ke kroku -->
        <div class="modal fade" id="addNoteModal{{ forloop.counter }}" tabindex="-1" aria-labelledby="addNoteModalLabel{{ forloop.counter }}" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form method="post">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title" id="addNoteModalLabel{{ forloop.counter }}">Přidat poznámku ke kroku: {{ step.popis }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Zavřít"></button>
                </div>
                <div class="modal-body">
                  <textarea name="text" class="form-control" rows="3" placeholder="Poznámka ke kroku..." required></textarea>
                  <input type="hidden" name="krok" value="{{ step.pole }}">
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zavřít</button>
                  <button type="submit" name="nova_poznamka_krok" class="btn btn-primary">Přidat poznámku</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% if not forloop.last %}
        <div class="align-self-center" style="width: 32px; height: 2px; background: #bbb;"></div>
      {% endif %}
    {% endfor %}
  </div>
</div>
<div class="mt-4">
  <a href="{% url 'klient_edit' klient.pk %}" class="btn btn-primary"><i class="fa fa-edit"></i> Upravit</a>
  <a href="{% url 'klient_delete' klient.pk %}" class="btn btn-danger"><i class="fa fa-trash"></i> Smazat</a>
  <a href="{% url 'export_klient_ical' klient.pk %}" class="btn btn-success"><i class="fa fa-calendar-plus"></i> Export deadlinů do kalendáře</a>
  <a href="{% url 'home' %}" class="btn btn-secondary"><i class="fa fa-arrow-left"></i> Zpět</a>
</div>
</div>
{% endblock %}
