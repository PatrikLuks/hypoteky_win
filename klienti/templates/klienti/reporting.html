{% extends 'base.html' %}
{% load klient_filters %}
{% block content %}
<div class="container-fluid py-4 px-2 px-md-4" role="main" aria-label="Reporting a statistika hypoték">
  <!-- Statistiky v luxusních boxech -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-lg-4">
      <div class="card border-0 shadow-sm h-100 bg-gradient bg-primary text-white">
        <div class="card-body d-flex flex-column align-items-center justify-content-center">
          <div class="display-5 fw-bold mb-2"><i class="fa fa-users"></i> {{ klientu_celkem }}</div>
          <div class="fs-5">Klientů v období</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-4">
      <div class="card border-0 shadow-sm h-100 bg-success bg-gradient text-white">
        <div class="card-body d-flex flex-column align-items-center justify-content-center">
          <div class="display-6 fw-bold mb-2"><i class="fa fa-check-circle"></i> {{ schvaleno_celkem }}</div>
          <div>Schválených hypoték</div>
        </div>
      </div>
    </div>
    <div class="col-6 col-lg-4">
      <div class="card border-0 shadow-sm h-100 bg-danger bg-gradient text-white">
        <div class="card-body d-flex flex-column align-items-center justify-content-center">
          <div class="display-6 fw-bold mb-2"><i class="fa fa-times-circle"></i> {{ zamitnuto_celkem }}</div>
          <div>Zamítnutých hypoték</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Grafy -->
  <div class="row g-4 mb-4">
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="fa fa-university text-primary"></i> Úspěšnost podle banky</h5>
          <canvas id="bankyBarChart" height="120" aria-label="Graf úspěšnosti podle banky" alt="Graf úspěšnosti podle banky"></canvas>
          <div class="table-responsive mt-3" aria-label="Tabulka úspěšnosti podle banky">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light"><tr><th>Banka</th><th>Schváleno</th><th>Zamítnuto</th><th>Průměrná doba schválení (dny)</th></tr></thead>
              <tbody>
                {% for banka in banky_labels %}
                <tr>
                  <td class="fw-bold">{{ banka }}</td>
                  <td class="text-success fw-semibold">{{ schvalenost|index:forloop.counter0 }}</td>
                  <td class="text-danger fw-semibold">{{ zamitnutost|index:forloop.counter0 }}</td>
                  <td>{% if prumery|index:forloop.counter0 %}<span class="badge bg-primary bg-opacity-75">{{ prumery|index:forloop.counter0 }}</span>{% else %}-{% endif %}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="fa fa-chart-line text-success"></i> Trendy schválených a zamítnutých hypoték</h5>
          <canvas id="trendyLineChart" height="120" aria-label="Graf trendů schválených a zamítnutých hypoték" alt="Graf trendů schválených a zamítnutých hypoték"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- Detailní tabulka klientů: přehled všech klientů v období -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title mb-3"><i class="fa fa-address-book text-info"></i> Detailní tabulka klientů</h5>
          <!-- Tlačítko pro export do CSV -->
          <button id="exportKlientiCsv" class="btn btn-outline-primary mb-3" aria-label="Exportovat tabulku klientů do CSV"><i class="fa fa-file-csv me-1"></i> Export do CSV</button>
          <!-- Responzivní tabulka klientů -->
          <div class="table-responsive" aria-label="Tabulka klientů">
            <table id="klientiTable" class="table table-striped table-hover align-middle small">
              <thead class="table-light">
                <tr>
                  <th>Jméno</th>
                  <th>Datum</th>
                  <th>Částka (Kč)</th>
                  <th>Banka</th>
                  <th>Stav</th>
                  <th>Důvod zamítnutí</th>
                </tr>
              </thead>
              <tbody>
                {% for klient in klienti %}
                <tr>
                  <td>{{ klient.jmeno }}</td>
                  <td>{{ klient.datum|date:'d.m.Y' }}</td>
                  <td>{% if klient.cena %}{{ klient.cena|floatformat:0 }}{% else %}-{% endif %}</td>
                  <td>{{ klient.vyber_banky|default:'-' }}</td>
                  <td>
                    {% if klient.duvod_zamitnuti %}
                      <span class="badge bg-danger bg-opacity-75">Zamítnuto</span>
                    {% else %}
                      <span class="badge bg-success bg-opacity-75">Schváleno</span>
                    {% endif %}
                  </td>
                  <td>{% if klient.duvod_zamitnuti %}<span class="text-warning fw-semibold">{{ klient.duvod_zamitnuti }}</span>{% else %}-{% endif %}</td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center text-muted">Žádní klienti v tomto období.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- Komentář pro studenta: Tabulka je optimalizovaná pro přístupnost, export a výkon. Pokud je klientů hodně, doporučuji stránkování nebo lazy loading. -->
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const bankyLabels = {{ banky_labels|safe }};
const schvalenost = {{ schvalenost|safe }};
const zamitnutost = {{ zamitnutost|safe }};
const prumery = {{ prumery|safe }};
const months = {{ months|safe }};
const schvaleneTimeline = {{ schvaleneTimeline|safe }};
const zamitnuteTimeline = {{ zamitnuteTimeline|safe }};
// Luxusní paleta pro banky (bude cyklovat podle počtu bank)
const bankyLuxusPaleta = [
  '#0A192F', // tmavě modrá
  '#FFD700', // zlatá
  '#F7E7CE', // champagne
  '#23272B', // tmavě šedá
  '#50C878', // smaragdová
  '#0F52BA', // safírová
  '#C0C0C0', // stříbrná
  '#800020', // vínová
  '#014421', // tmavě zelená
  '#4B006E', // tmavě fialová
  '#E5E4E2', // platinová
  '#B76E79', // růžové zlato
  '#CD7F32', // bronzová
  '#B2FFFF', // ledově modrá
  '#B2BABB'  // světle šedá
];
const barvyBanky = Array.from({length: bankyLabels.length}, (_, i) => bankyLuxusPaleta[i % bankyLuxusPaleta.length]);
// Bar chart - úspěšnost podle banky
const ctxBanky = document.getElementById('bankyBarChart').getContext('2d');
new Chart(ctxBanky, {
  type: 'bar',
  data: {
    labels: bankyLabels,
    datasets: [
      {
        label: 'Schváleno',
        data: schvalenost,
        backgroundColor: barvyBanky
      },
      {
        label: 'Zamítnuto',
        data: zamitnutost,
        backgroundColor: '#dc3545'
      }
    ]
  },
  options: {
    plugins: {legend: {position: 'bottom'}},
    scales: {y: {beginAtZero: true}},
    responsive: true,
    animation: {duration: 900}
  }
});
// Line chart - trendy
const ctxTrendy = document.getElementById('trendyLineChart').getContext('2d');
new Chart(ctxTrendy, {
  type: 'line',
  data: {
    labels: months,
    datasets: [
      {label: 'Schváleno', data: schvaleneTimeline, borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', tension: 0.3, fill: true},
      {label: 'Zamítnuto', data: zamitnuteTimeline, borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', tension: 0.3, fill: true}
    ]
  },
  options: {
    plugins: {legend: {position: 'bottom'}},
    scales: {y: {beginAtZero: true}},
    responsive: true,
    animation: {duration: 900}
  }
});
// Export tabulky klientů do CSV (čistý JS, optimalizováno pro výkon)
document.getElementById('exportKlientiCsv').addEventListener('click', function() {
  const table = document.getElementById('klientiTable');
  let csv = [];
  for (let row of table.rows) {
    let rowData = [];
    for (let cell of row.cells) {
      // Ošetření čárek a uvozovek v datech
      let text = cell.innerText.replace(/"/g, '""');
      rowData.push('"' + text + '"');
    }
    csv.push(rowData.join(','));
  }
  const blob = new Blob([csv.join('\n')], {type: 'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'klienti_export.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});
</script>
{% endblock %}
